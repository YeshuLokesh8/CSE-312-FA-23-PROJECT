<!DOCTYPE html>

<html>
<head>
    <title>Project</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
</head>

<body>
    <script>
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        socket.on('new_post', function(post) {
            addPostToDOM(post);
            startTimer(post._id, post.expiration_time);
        });

        socket.on('connect', function() {
            console.log('Websocket connected!');
            socket.emit('start_timer', {data: 'User has connected!'});
        });

        function startTimer(postId, expirationTime) {
            var timerElement = document.getElementById(`timer-${postId}`);

            var timerInterval = setInterval(function() {
                var currentTime = Math.floor(Date.now() / 1000);
                var timeRemaining = expirationTime - currentTime;

                if (timeRemaining <= 0) {
                    // Timer has expired, handle as needed (e.g., disable answer submission)
                    clearInterval(timerInterval);
                    disableAnswerSubmission(postId);
                    timerElement.innerText = 'Time Remaining: ' + timeRemaining + ' seconds';
                } else {
                    // Update the timer on the page
                    timerElement.innerText = 'Time Remaining: ' + timeRemaining + ' seconds';
                }
            }, 1000);
        }

        function disableAnswerSubmission(postId) {
            // Disable the answer submission input or take any other actions
            var answerInput = document.getElementById(`answer-input-${postId}`);
            answerInput.disabled = true;
        }

        function addPostToDOM(post) {
            // Start building the HTML string for the post
            var postHtml = '<div class="post">' +
                           '<h3>' + post.title + ' by <span class="username">' + post.author + '</span></h3>' +
                           '<p>' + post.description + '</p>';

            if(post.image) {
                postHtml += '<div class="post-image">' +
                            '<img src="/static/' + post.image + '" alt="Question Image">' +
                            '</div>';
            }

            postHtml += '<ol type="A"></ol>';

            postHtml += '<form action="/like-or-unlike-post/' + post._id + '" method="post">' +
                        '<input type="text" name="action" id="answer-input-' + post._id + '">' +
                        '</form>' +
                        '<div id="timer-' + post._id + '"></div>' +
                        '</div>';

            var mainContentElement = document.getElementById('main-content');
            mainContentElement.innerHTML += postHtml;
        }
    </script>

    <h1>X.com</h1>
    
    <h2>Hello, {{ usr }}</h2>

    <a href="/questionForm.html">Create a question</a>

    <div id="main-content">
        {% for post in posts %}
        <div class="post">
            <h3>{{ post.title }} by <span class="username">{{ post.author }}</span></h3>
            <p>{{ post.description }}</p>
            {% if post.author == usr %}
            <form action="/like-or-unlike-post/{{ post._id }}" method="post" hidden>
                <input type="text" name="action" id="answer-input-{{ post._id }}">
            </form>
            {% else %}
            <form action="/like-or-unlike-post/{{ post._id }}" method="post">
                <input type="text" name="action" id="answer-input-{{ post._id }}">
            </form>
            <div id="timer-{{ post._id }}"></div>
            {% endif %}
            {% if post.image %}
                <div class="post-image">
                    <img src="{{ url_for('static', filename=post.image) }}" alt="Question Image">
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</body>
</html>